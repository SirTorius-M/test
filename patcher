#!/bin/sh

# Define URLs and target paths
URL_BUSYBOX="https://raw.githubusercontent.com/SirTorius-M/test/main/bin/busybox"
URL_MAGISK_BOOT="https://raw.githubusercontent.com/SirTorius-M/test/main/bin/magiskboot"
URL_SHELLCODE="https://raw.githubusercontent.com/SirTorius-M/test/main/bin/BootShim.Dualboot.bin"
URL_KP="https://raw.githubusercontent.com/SirTorius-M/test/main/bin/kernelpatcher"
URL_UEFI="https://raw.githubusercontent.com/SirTorius-M/test/main/bin/nabu_UEFI.fd"

TARGET_DIR="$(pwd)"
TARGET_BUSYBOX="$(pwd)/busybox"
TARGET_MAGISK_BOOT="$(pwd)/magiskboot"
TARGET_SHELLCODE="$(pwd)/BootShim.Dualboot.bin"
TARGET_KP="$(pwd)/kernelpatcher"
TARGET_UEFI="$(pwd)/nabu_UEFI.fd"
TARGET_BOOT="/dev/block/platform/soc/1d84000.ufshc/by-name/boot$(getprop ro.boot.slot_suffix)"

log() {
    echo ""
    echo "[$(date +"%H:%M:%S")] $1"
}

# Check device compatibility
DEVICE_CODENAME=$(getprop ro.product.device)
if [ "$DEVICE_CODENAME" != "nabu" ]; then
    log "[ERROR] Unsupported device: $DEVICE_CODENAME"
    exit 1
fi

log "[INFO] EDK2-UEFI PATCHER for Xiaomi Pad 5 ($DEVICE_CODENAME)"

# Function to download and set permissions
download_and_set_permissions() {
    local url=$1 dest_file=$2
    log "[INFO] Downloading $(basename "$dest_file")..."
    curl -s -L -o "$dest_file" "$url" || { log "[ERROR] Failed to download $(basename "$dest_file")"; exit 1; }
    chmod 777 "$dest_file"
    log "[SUCCESS] $(basename "$dest_file") ready."
}

mkdir -p "$TARGET_DIR"
cd "$TARGET_DIR"

# Download busybox first
download_and_set_permissions "$URL_BUSYBOX" "$TARGET_BUSYBOX"

# Download remaining files
download_and_set_permissions "$URL_MAGISK_BOOT" "$TARGET_MAGISK_BOOT"
download_and_set_permissions "$URL_SHELLCODE" "$TARGET_SHELLCODE"
download_and_set_permissions "$URL_KP" "$TARGET_KP"
download_and_set_permissions "$URL_UEFI" "$TARGET_UEFI"

log "[INFO] Backing up boot.img..."
$TARGET_BUSYBOX dd if="$TARGET_BOOT" of="$(pwd)/boot.img" bs=8M || { log "[ERROR] Failed to dump boot image!"; exit 1; }
$TARGET_BUSYBOX cp -f "$(pwd)/boot.img" "/sdcard/boot_backup$(getprop ro.boot.slot_suffix).img"
log "[SUCCESS] Boot image backup completed."

log "[INFO] Unpacking boot.img..."
$TARGET_MAGISK_BOOT unpack -h "$(pwd)/boot.img" || { log "[ERROR] Failed to unpack image!"; exit 1; }
log "[SUCCESS] Unpacking completed."

log "[INFO] Checking for existing UEFI installation..."
if [ "$($TARGET_BUSYBOX dd if="$TARGET_DIR/kernel" bs=1 count=8 skip=64 status=none)" = "EDK2-MSM" ]; then
    log "[INFO] Patched boot.img with UEFI detected, updating..."
    KERNEL_SIZE=$($TARGET_BUSYBOX dd if="$TARGET_DIR/kernel" bs=1 count=4 skip=48 status=none | od -An -t u)
    log "[INFO] Extracting original kernel size: $KERNEL_SIZE bytes"
    $TARGET_BUSYBOX dd if="$TARGET_DIR/kernel" of="$TARGET_DIR/kernel_orig" bs=1 count=$KERNEL_SIZE status=none
else
    log "[INFO] Stock boot.img detected, installing..."
    mv "$TARGET_DIR/kernel" "$TARGET_DIR/kernel_orig"
fi

log "[INFO] Patching kernel..."
PAYLOAD_SIZE=$($TARGET_BUSYBOX stat -c "%s" "$TARGET_UEFI")
$TARGET_KP "$TARGET_DIR/kernel_orig" "$TARGET_SHELLCODE" $PAYLOAD_SIZE || { log "[ERROR] Kernel patching failed!"; exit 1; }
log "[SUCCESS] Kernel patching completed."

log "[INFO] Merging patched kernel with UEFI..."
$TARGET_BUSYBOX cat "$(pwd)/kernel" "$TARGET_UEFI" > "$(pwd)/new_kernel"
$TARGET_BUSYBOX mv -f "$(pwd)/new_kernel" "$(pwd)/kernel"
log "[SUCCESS] Kernel merge completed."

log "[INFO] Repacking boot.img..."
$TARGET_MAGISK_BOOT repack "$(pwd)/boot.img" || { log "[ERROR] Failed to repack boot image!"; exit 1; }
$TARGET_MAGISK_BOOT cleanup
log "[SUCCESS] Boot.img repacking completed."

log "[INFO] Flashing new patched boot image..."
$TARGET_BUSYBOX dd if="$(pwd)/new-boot.img" of="$TARGET_BOOT" bs=8M || { log "[ERROR] Failed to flash patched boot image!"; exit 1; }
$TARGET_BUSYBOX cp -f "$(pwd)/new-boot.img" "/sdcard/patched_boot.img"
log "[SUCCESS] Patched boot backup completed."

log "[INFO] Cleaning up temporary files..."
rm -rf "$TARGET_DIR"
log "[SUCCESS] Cleanup complete."

log "[COMPLETED] edk2-msm UEFI installed successfully!"

log "Do you want to reboot? (y/n)"
read -r answer
if [ "$answer" = "y" ]; then
    log "Rebooting now..."
    reboot
else
    log "Exiting..."
    exit 0
fi
